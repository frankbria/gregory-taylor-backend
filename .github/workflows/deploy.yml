name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip lint/build checks'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # CI: Lint and Build
  # ============================================
  ci:
    name: Lint & Build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Build application
        run: npm run build
        env:
          # Provide dummy values for build-time env vars
          MONGODB_URI: mongodb://localhost:27017/test
          BETTER_AUTH_SECRET: build-time-dummy-secret-32chars
          NEXT_PUBLIC_ADMIN_API_KEY: build-time-key
          STRIPE_SECRET_KEY: sk_test_dummy
          STRIPE_WEBHOOK_SECRET: whsec_dummy
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_dummy
          CLOUDINARY_CLOUD_NAME: dummy
          CLOUDINARY_API_KEY: dummy
          CLOUDINARY_API_SECRET: dummy
          CORS_ALLOWED_ORIGINS: http://localhost:3000

  # ============================================
  # CD: Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci]
    if: |
      always() &&
      (needs.ci.result == 'success' || needs.ci.result == 'skipped') &&
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'workflow_dispatch'

    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          NEXT_PUBLIC_ADMIN_API_KEY: ${{ secrets.NEXT_PUBLIC_ADMIN_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          NEXT_PUBLIC_INVITE_CODE: ${{ secrets.INVITE_CODE }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ vars.SERVER_SSH_PORT || 22 }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment package
        run: |
          mkdir -p deploy_package
          cp -r .next deploy_package/
          cp -r public deploy_package/
          cp package.json deploy_package/
          cp package-lock.json deploy_package/
          cp ecosystem.config.cjs deploy_package/
          cp next.config.mjs deploy_package/ 2>/dev/null || cp next.config.js deploy_package/ 2>/dev/null || true

      - name: Create .env file for production
        run: |
          cat > deploy_package/.env << 'EOF'
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
          NEXT_PUBLIC_ADMIN_API_KEY=${{ secrets.NEXT_PUBLIC_ADMIN_API_KEY }}
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
          INVITE_CODE=${{ secrets.INVITE_CODE }}
          PORT=${{ vars.APP_PORT }}
          EOF

      - name: Deploy to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ vars.SERVER_SSH_PORT || 22 }}" \
            deploy_package/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ vars.DEPLOY_PATH }}/

      - name: Install dependencies and restart app
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ vars.SERVER_SSH_PORT || 22 }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          cd ${{ vars.DEPLOY_PATH }}

          # Install production dependencies only
          npm ci --production

          # Stop and delete existing process (ignore errors if not found)
          pm2 delete ${{ vars.PM2_APP_NAME }} 2>/dev/null || true

          # Start fresh
          pm2 start ecosystem.config.cjs --env production

          # Save PM2 process list
          pm2 save

          echo "Deployment complete!"
          ENDSSH

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key -p ${{ vars.SERVER_SSH_PORT || 22 }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          # Check if the app is running
          if pm2 describe ${{ vars.PM2_APP_NAME }} | grep -q "online"; then
            echo "App is running successfully!"
            pm2 logs ${{ vars.PM2_APP_NAME }} --lines 5 --nostream
          else
            echo "App failed to start!"
            pm2 logs ${{ vars.PM2_APP_NAME }} --lines 20 --nostream
            exit 1
          fi
          ENDSSH

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key
